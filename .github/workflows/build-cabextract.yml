name: Build Static Cabextract

on:
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - '.github/workflows/build-cabextract.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Install build dependencies
        run: |
          apk add --no-cache \
            build-base \
            wget \
            tar \
            linux-headers

      - name: Download and extract cabextract source
        run: |
          wget https://www.cabextract.org.uk/cabextract-1.11.tar.gz
          tar xzf cabextract-1.11.tar.gz
          cd cabextract-1.11

      - name: Build static cabextract
        run: |
          cd cabextract-1.11
          # Remove bundled getopt.h that conflicts with musl's version
          rm -f getopt.h
          # Configure with static linking
          LDFLAGS="-static" ./configure
          make
          # Verify it's statically linked
          file cabextract
          # Strip to reduce size
          strip cabextract
          ls -la cabextract

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cabextract-linux-x86_64
          path: cabextract-1.11/cabextract

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: cabextract-linux-x86_64

      - name: Create or update tools release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: tools
          name: "Bundled Tools"
          body: |
            Static binaries for systems without package managers (like SteamOS).

            - `cabextract-linux-x86_64` - Static cabextract 1.11 for extracting .cab files
          files: cabextract
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename and re-upload with correct name
        run: |
          mv cabextract cabextract-linux-x86_64

      - name: Update release with renamed file
        uses: softprops/action-gh-release@v1
        with:
          tag_name: tools
          files: cabextract-linux-x86_64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
