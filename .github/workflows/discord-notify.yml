name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Determine if this is a pre-release
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            TITLE="NaK Pre-Release ${{ github.event.release.tag_name }}"
            COLOR=16744192  # Orange for pre-release
            ROLE_PING=""  # Optional: Add role ID if you want to ping a role
          else
            TITLE="NaK ${{ github.event.release.tag_name }} Released!"
            COLOR=3066993  # Green for stable
            ROLE_PING=""
          fi

          # Truncate release notes if too long (Discord has 4096 char limit for description)
          BODY="${{ github.event.release.body }}"
          if [ ${#BODY} -gt 2000 ]; then
            BODY="${BODY:0:2000}..."
          fi

          # Escape special characters for JSON
          BODY=$(echo "$BODY" | jq -Rs .)

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"url\": \"${{ github.event.release.html_url }}\",
                \"description\": $BODY,
                \"color\": $COLOR,
                \"footer\": {
                  \"text\": \"NaK - Linux Modding Helper\"
                },
                \"timestamp\": \"${{ github.event.release.published_at }}\"
              }]
            }" \
            $DISCORD_WEBHOOK
