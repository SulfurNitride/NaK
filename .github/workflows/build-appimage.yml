name: Build AppImage

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download winetricks
      run: |
        wget -q https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks
        chmod +x winetricks

    - name: Build Flet AppImage
      run: |
        chmod +x build_flet.sh
        ./build_flet.sh

    - name: Get version info
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "version=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        fi

    - name: Rename AppImage with version
      run: |
        mv NaK-Linux-Modding-Helper-Flet.AppImage \
           NaK-Linux-Modding-Helper-${{ steps.version.outputs.version }}-x86_64.AppImage

    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: NaK-Linux-Modding-Helper-${{ steps.version.outputs.version }}-x86_64.AppImage
        path: NaK-Linux-Modding-Helper-*.AppImage
        retention-days: 90
        compression-level: 0  # No compression - keep raw AppImage

    - name: Upload to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: NaK-Linux-Modding-Helper-*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create build info
      run: |
        cat > build-info.txt << EOF
        Build Information:
        ==================
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Built with: Docker (Ubuntu 22.04 base)
        Compatible with: Ubuntu 22.04+, Debian 12+, Fedora 36+, and other distros with glibc â‰¥ 2.35
        GUI Framework: Flet (Flutter-based Material Design)
        EOF
        cat build-info.txt

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.txt
